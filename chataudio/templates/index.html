<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LMStudio Chat</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #history { height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; white-space: pre-wrap; background: #f9f9f9; }
  #controls { margin-top: 10px; }
  #prompt { width: 80%; padding: 8px; }
  button { padding: 8px 12px; }
  label { margin-left: 10px; }
</style>
</head>
<body>
<h2>LMStudio Chat Custom design</h2>
<div id="history"></div>

    <!-- CHAT HISTORY DIV (CHANGE: colored messages will appear here) -->
    <div id="chat-history"></div>  <!-- CHANGE -->

<div id="controls">
  <input type="text" id="prompt" placeholder="Type your question here" />
  <button id="sendBtn">Send</button>
  <label><input type="checkbox" id="audioToggle" /> Record Audio</label>
</div>

<script>
let recording = false;
let mediaRecorder;
let audioChunks = [];

const historyEl = document.getElementById('history');
const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('sendBtn');
const audioToggle = document.getElementById('audioToggle');

function appendHistory(text) {
  historyEl.textContent += text + "\n\n";
  historyEl.scrollTop = historyEl.scrollHeight;
}

async function sendText(text) {
  if (!text.trim()) return;
  appendHistory(`You: ${text}`);
  promptEl.value = '';
  
  try {
    const res = await fetch("/text_query", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: text }),
    });
    const data = await res.json();
    if (data.answer) {
      appendHistory(`LMStudio: ${data.answer}`);
      // Instead of appendHistory(`LMStudio: ${data.answer}`);
      //chatHistoryDiv.innerHTML = data.history;  // CHANGE
      //chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;




    } else if(data.error) {
      appendHistory(`Error: ${data.error}`);
    }
  } catch(e) {
    appendHistory(`Error sending text: ${e}`);
  }
}

sendBtn.addEventListener('click', () => {
  sendText(promptEl.value);
});

promptEl.addEventListener('keypress', (e) => {
  if(e.key === 'Enter' && !audioToggle.checked) {
    sendText(promptEl.value);
  }
});

// Audio recording handling
audioToggle.addEventListener('change', async () => {
  if (audioToggle.checked) {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Audio recording not supported in your browser.");
      audioToggle.checked = false;
      return;
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        audioChunks = [];

        appendHistory("ðŸŽ™ Audio sent for transcription...");

        const formData = new FormData();
        formData.append("audio", audioBlob, "recording.wav");

        try {
          const res = await fetch("/audio_query", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.user_text) appendHistory(`You (speech): ${data.user_text}`);
          if (data.answer) appendHistory(`LMStudio: ${data.answer}`);
          if (data.error) appendHistory(`Error: ${data.error}`);
        } catch(e) {
          appendHistory(`Error sending audio: ${e}`);
        }
      };

      mediaRecorder.start();
      appendHistory("ðŸŽ¤ Recording started...");
    } catch (err) {
      alert("Error accessing microphone: " + err);
      audioToggle.checked = false;
    }
  } else {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
      appendHistory("ðŸ›‘ Recording stopped.");
    }
  }
});
</script>
</body>
</html>
